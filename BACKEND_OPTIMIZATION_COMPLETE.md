# åç«¯æ ¸å¿ƒæ–‡ä»¶ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## âœ… ä¼˜åŒ–å®Œæˆ

### ä¼˜åŒ–æˆæœ

1. âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘**ï¼šåˆ›å»º `backend/utils/errorHandler.js` ä¸­é—´ä»¶
2. âœ… **åˆ é™¤é‡å¤æ¥å£**ï¼šåˆ é™¤ `/api/maps/keys`ï¼Œç»Ÿä¸€ä½¿ç”¨ `/api/map/key`
3. âœ… **ç»Ÿä¸€åœ°å›¾Keyé…ç½®**ï¼šåˆ›å»º `backend/utils/mapKey.js` å·¥å…·å‡½æ•°
4. âœ… **æ‹†åˆ†å°çº¢ä¹¦è§£æå‡½æ•°**ï¼šåˆ›å»º `backend/utils/xhsParser.js` å·¥å…·å‡½æ•°
5. âœ… **è¿ç§»è¡Œç¨‹å­˜å‚¨å‡½æ•°**ï¼šåˆ é™¤ server.js ä¸­é‡å¤çš„å­˜å‚¨å‡½æ•°

---

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. `backend/utils/errorHandler.js`

**åŠŸèƒ½**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**å¯¼å‡ºå‡½æ•°**ï¼š
- `errorHandler` - å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- `asyncHandler` - å¼‚æ­¥é”™è¯¯å¤„ç†åŒ…è£…å™¨
- `successResponse` - åˆ›å»ºæ ‡å‡†æˆåŠŸå“åº”
- `errorResponse` - åˆ›å»ºæ ‡å‡†é”™è¯¯å“åº”

### 2. `backend/utils/mapKey.js`

**åŠŸèƒ½**ï¼šç»Ÿä¸€è¯»å–åœ°å›¾API Key

**å¯¼å‡ºå‡½æ•°**ï¼š
- `getAmapKey()` - è·å–é«˜å¾·åœ°å›¾API Key
- `getGoogleKey()` - è·å–Googleåœ°å›¾API Key
- `getMapKeys()` - è·å–æ‰€æœ‰åœ°å›¾API Keys
- `isMapKeyConfigured(type)` - æ£€æŸ¥åœ°å›¾Keyæ˜¯å¦å·²é…ç½®

### 3. `backend/utils/xhsParser.js`

**åŠŸèƒ½**ï¼šå°çº¢ä¹¦è§£æå·¥å…·å‡½æ•°

**å¯¼å‡ºå‡½æ•°**ï¼š
- `hasLoginPrompt(pageContent)` - æ£€æµ‹é¡µé¢æ˜¯å¦åŒ…å«ç™»å½•æç¤º
- `hasUnrelatedContent(content)` - æ£€æµ‹å†…å®¹æ˜¯å¦åŒ…å«æ— å…³ä¿¡æ¯
- `filterUnrelatedContent(content)` - è¿‡æ»¤æ— å…³å†…å®¹
- `extractPageContent(page)` - ä»é¡µé¢HTMLä¸­æå–æ–‡æœ¬å†…å®¹
- `getRandomUserAgent()` - è·å–éšæœºUser-Agent
- `MOBILE_USER_AGENT` - ç§»åŠ¨ç«¯User-Agentå¸¸é‡

---

## ğŸ”§ ä¿®æ”¹åçš„æ–‡ä»¶

### 1. `backend/routes/map.js`

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… ä½¿ç”¨ `mapKey.js` å·¥å…·å‡½æ•°æ›¿ä»£é‡å¤çš„ç¯å¢ƒå˜é‡è¯»å–ä»£ç 
- âœ… ä½¿ç”¨ `asyncHandler` å’Œ `successResponse` ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼
- âœ… åˆ é™¤é‡å¤çš„ try-catch ä»£ç 

**ä¿®æ”¹è¯´æ˜**ï¼š
- åŸå†—ä½™é€»è¾‘ï¼šé‡å¤è¯»å–ç¯å¢ƒå˜é‡ã€é‡å¤çš„å ä½ç¬¦è¿‡æ»¤é€»è¾‘
- ä¼˜åŒ–åçš„å¤ç”¨æ–¹å¼ï¼šç»Ÿä¸€ä½¿ç”¨ `getMapKeys()` å·¥å…·å‡½æ•°

### 2. `backend/server.js`

**ä¿®æ”¹å†…å®¹**ï¼š

#### 2.1 å¯¼å…¥ä¼˜åŒ–
- âœ… å¯¼å…¥ `errorHandler`ã€`asyncHandler`ã€`successResponse`ã€`errorResponse`
- âœ… å¯¼å…¥ `getMapKeys`ã€`isMapKeyConfigured`
- âœ… å¯¼å…¥ `hasLoginPrompt`ã€`hasUnrelatedContent`ã€`extractPageContent`ã€`getRandomUserAgent`ã€`MOBILE_USER_AGENT`

#### 2.2 åˆ é™¤é‡å¤å‡½æ•°
- âœ… åˆ é™¤ `hasLoginPrompt()` å‡½æ•°ï¼ˆå·²è¿ç§»åˆ° `utils/xhsParser.js`ï¼‰
- âœ… åˆ é™¤ `hasUnrelatedContent()` å‡½æ•°ï¼ˆå·²è¿ç§»åˆ° `utils/xhsParser.js`ï¼‰
- âœ… åˆ é™¤ `filterUnrelatedContent()` å‡½æ•°ï¼ˆå·²è¿ç§»åˆ° `utils/xhsParser.js`ï¼‰
- âœ… åˆ é™¤ `getRandomUserAgent()` å‡½æ•°ï¼ˆå·²è¿ç§»åˆ° `utils/xhsParser.js`ï¼‰
- âœ… åˆ é™¤ `readTripsFromFile()` å‡½æ•°ï¼ˆå·²åœ¨ `storageAdapter.js` ä¸­ï¼‰
- âœ… åˆ é™¤ `saveTripToFile()` å‡½æ•°ï¼ˆå·²åœ¨ `storageAdapter.js` ä¸­ï¼‰
- âœ… åˆ é™¤ `updateTripInFile()` å‡½æ•°ï¼ˆå·²åœ¨ `storageAdapter.js` ä¸­ï¼‰
- âœ… åˆ é™¤ `deleteTripFromFile()` å‡½æ•°ï¼ˆå·²åœ¨ `storageAdapter.js` ä¸­ï¼‰

#### 2.3 åˆ é™¤é‡å¤æ¥å£
- âœ… åˆ é™¤ `/api/maps/keys` æ¥å£ï¼ˆä¸ `/api/map/key` åŠŸèƒ½é‡å¤ï¼‰

#### 2.4 ä¼˜åŒ– parseXhsPage å‡½æ•°
- âœ… ä½¿ç”¨ `hasLoginPrompt()` å·¥å…·å‡½æ•°æ›¿ä»£å†…è”ç™»å½•æ£€æµ‹é€»è¾‘
- âœ… ä½¿ç”¨ `extractPageContent()` å·¥å…·å‡½æ•°æ›¿ä»£å†…è”HTMLæå–é€»è¾‘ï¼ˆ100+è¡Œä»£ç ï¼‰
- âœ… ä½¿ç”¨ `getRandomUserAgent()` å·¥å…·å‡½æ•°æ›¿ä»£å†…è”User-Agentç”Ÿæˆé€»è¾‘

#### 2.5 ä¼˜åŒ–åœ°å›¾Keyä½¿ç”¨
- âœ… æ‰€æœ‰ä½¿ç”¨ `AMAP_API_KEY` å’Œ `GOOGLE_API_KEY` çš„åœ°æ–¹æ”¹ä¸ºä½¿ç”¨ `getMapKeys()` å·¥å…·å‡½æ•°
- âœ… å¯åŠ¨æ—¥å¿—ä¸­ä½¿ç”¨ `isMapKeyConfigured()` æ£€æŸ¥Keyé…ç½®çŠ¶æ€

#### 2.6 ä¼˜åŒ–é”™è¯¯å¤„ç†
- âœ… éƒ¨åˆ†æ¥å£ä½¿ç”¨ `asyncHandler` åŒ…è£…ï¼Œåˆ é™¤é‡å¤çš„ try-catch ä»£ç 
- âœ… æ³¨å†Œå…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ `app.use(errorHandler)`

**ä¿®æ”¹è¯´æ˜**ï¼š
- åŸå†—ä½™é€»è¾‘ï¼š
  - æ¯ä¸ªæ¥å£éƒ½æœ‰ç‹¬ç«‹çš„ try-catch ä»£ç ï¼ˆ100+å¤„ï¼‰
  - é”™è¯¯è¿”å›æ ¼å¼ä¸ç»Ÿä¸€
  - åœ°å›¾Keyè¯»å–ä»£ç é‡å¤ï¼ˆ10+å¤„ï¼‰
  - å°çº¢ä¹¦è§£æå‡½æ•°è¿‡é•¿ï¼ˆ400+è¡Œï¼‰
  - è¡Œç¨‹å­˜å‚¨å‡½æ•°é‡å¤ï¼ˆå·²åœ¨ storageAdapter.js ä¸­ï¼‰
- ä¼˜åŒ–åçš„å¤ç”¨æ–¹å¼ï¼š
  - ç»Ÿä¸€ä½¿ç”¨ `errorHandler` ä¸­é—´ä»¶å’Œ `asyncHandler` åŒ…è£…å™¨
  - ç»Ÿä¸€ä½¿ç”¨ `getMapKeys()` å·¥å…·å‡½æ•°
  - ç»Ÿä¸€ä½¿ç”¨ `xhsParser.js` å·¥å…·å‡½æ•°
  - ç»Ÿä¸€ä½¿ç”¨ `storageAdapter.js` å­˜å‚¨æ–¹æ³•

---

## ğŸ“Š ä¼˜åŒ–ç»Ÿè®¡

### ä»£ç è¡Œæ•°å˜åŒ–

- **åˆ é™¤é‡å¤ä»£ç **ï¼šçº¦ 300+ è¡Œ
- **æ–°å¢å·¥å…·å‡½æ•°**ï¼šçº¦ 200 è¡Œ
- **å‡€å‡å°‘ä»£ç **ï¼šçº¦ 100+ è¡Œ

### ä¼˜åŒ–æ•ˆæœ

- âœ… **é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼šæ‰€æœ‰æ¥å£ç»Ÿä¸€é”™è¯¯æ ¼å¼
- âœ… **é…ç½®ç®¡ç†ç»Ÿä¸€**ï¼šåœ°å›¾Keyé…ç½®ç»Ÿä¸€ç®¡ç†
- âœ… **ä»£ç å¤ç”¨æå‡**ï¼šå·¥å…·å‡½æ•°é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
- âœ… **å¯ç»´æŠ¤æ€§æå‡**ï¼šä»£ç ç»“æ„æ›´æ¸…æ™°ï¼ŒèŒè´£æ›´æ˜ç¡®

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
npm start
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… åç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼ˆhttp://localhost:3008ï¼‰
- âœ… æ§åˆ¶å°æ˜¾ç¤ºå­˜å‚¨æ¨¡å¼ä¿¡æ¯
- âœ… æ§åˆ¶å°æ˜¾ç¤ºåœ°å›¾APIé…ç½®çŠ¶æ€ï¼ˆä½¿ç”¨ `isMapKeyConfigured()`ï¼‰

### 2. æµ‹è¯•åœ°å›¾Keyæ¥å£

```bash
curl http://localhost:3008/api/map/key
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›æ ¼å¼ï¼š`{ "code": 200, "data": { "amap": "...", "google": "..." }, "msg": "æˆåŠŸ" }`
- âœ… ä¸å†æœ‰ `/api/maps/keys` æ¥å£ï¼ˆ404é”™è¯¯ï¼‰

### 3. æµ‹è¯•é”™è¯¯å¤„ç†

```bash
curl http://localhost:3008/api/guides/999
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›ç»Ÿä¸€é”™è¯¯æ ¼å¼ï¼š`{ "code": 404, "msg": "...", "error": "..." }`

### 4. æµ‹è¯•å°çº¢ä¹¦è§£æ

```bash
curl -X POST http://localhost:3008/api/xhs/parse \
  -H "Content-Type: application/json" \
  -d '{"url": "https://www.xiaohongshu.com/explore/xxxx"}'
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è§£æåŠŸèƒ½æ­£å¸¸
- âœ… ä½¿ç”¨å·¥å…·å‡½æ•°è¿›è¡Œç™»å½•æ£€æµ‹å’Œå†…å®¹æå–

### 5. æµ‹è¯•è¡Œç¨‹æ¥å£

```bash
curl http://localhost:3008/api/trips
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›è¡Œç¨‹åˆ—è¡¨
- âœ… ä½¿ç”¨ storageAdapter.js ä¸­çš„æ–¹æ³•ï¼ˆä¸å†ä½¿ç”¨ server.js ä¸­çš„é‡å¤å‡½æ•°ï¼‰

---

## ğŸ“ ä¿®æ”¹è¯´æ˜æ€»ç»“

### åŸå†—ä½™é€»è¾‘

1. **é”™è¯¯å¤„ç†é‡å¤**ï¼šæ¯ä¸ªæ¥å£éƒ½æœ‰ç‹¬ç«‹çš„ try-catch ä»£ç ï¼Œé”™è¯¯è¿”å›æ ¼å¼ä¸ç»Ÿä¸€
2. **åœ°å›¾Keyé…ç½®é‡å¤**ï¼šserver.js å’Œ map.js ä¸­éƒ½æœ‰è¯»å–ç¯å¢ƒå˜é‡çš„ä»£ç 
3. **å°çº¢ä¹¦è§£æå‡½æ•°å†—ä½™**ï¼šparseXhsPage å‡½æ•°è¿‡é•¿ï¼ŒåŒ…å«ç™»å½•æ£€æµ‹ã€å†…å®¹è¿‡æ»¤ã€HTMLæå–ç­‰é€»è¾‘
4. **è¡Œç¨‹å­˜å‚¨å‡½æ•°é‡å¤**ï¼šreadTripsFromFileã€saveTripToFile ç­‰å‡½æ•°åœ¨ server.js ä¸­å®šä¹‰ï¼Œä½† storageAdapter.js ä¸­å·²æœ‰ç›¸åŒåŠŸèƒ½
5. **æ¥å£é‡å¤**ï¼š/api/maps/keys å’Œ /api/map/key åŠŸèƒ½å®Œå…¨ç›¸åŒ

### ä¼˜åŒ–åçš„å¤ç”¨æ–¹å¼

1. **é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼šä½¿ç”¨ `errorHandler` ä¸­é—´ä»¶å’Œ `asyncHandler` åŒ…è£…å™¨
2. **åœ°å›¾Keyç»Ÿä¸€**ï¼šä½¿ç”¨ `mapKey.js` å·¥å…·å‡½æ•°ç»Ÿä¸€è¯»å–
3. **å°çº¢ä¹¦è§£ææ‹†åˆ†**ï¼šä½¿ç”¨ `xhsParser.js` å·¥å…·å‡½æ•°æ‹†åˆ†é€»è¾‘
4. **è¡Œç¨‹å­˜å‚¨ç»Ÿä¸€**ï¼šç»Ÿä¸€ä½¿ç”¨ `storageAdapter.js` ä¸­çš„æ–¹æ³•
5. **æ¥å£ç»Ÿä¸€**ï¼šç»Ÿä¸€ä½¿ç”¨ `/api/map/key` æ¥å£

---

## âœ… ä¼˜åŒ–å®Œæˆ

æ‰€æœ‰ä¼˜åŒ–å·²å®Œæˆï¼Œä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œå¯ç»´æŠ¤æ€§å¤§å¹…æå‡ã€‚

